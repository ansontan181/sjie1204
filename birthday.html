<script>
// ===== 高空烟花（更稳版）=====
const cvs = document.getElementById('fw'), ctx = cvs.getContext('2d');

// 1) 画布尺寸：兼容手机地址栏伸缩
function fit(){
  const h = Math.max(window.innerHeight, window.visualViewport ? window.visualViewport.height : window.innerHeight);
  cvs.width = window.innerWidth;
  cvs.height = h;
}
addEventListener('resize', fit, {passive:true}); fit();

let W=cvs.width, H=cvs.height;
addEventListener('resize', ()=>{ W=cvs.width; H=cvs.height; }, {passive:true});

// 工具函数
const rnd=(a,b)=>a+Math.random()*(b-a);
const hsv=(h,s,v)=>{ let f=(n,k=(n+h/60)%6)=>v-v*s*Math.max(Math.min(k,4-k,1),0); return [f(5)*255,f(3)*255,f(1)*255]; };

// 状态
const rockets=[], particles=[];
const G=0.06, DRAG=0.985;

// 2) 生成火箭（默认从屏幕中部左右起飞）
function spawnRocket(x=rnd(W*0.25, W*0.75)){
  rockets.push({ x, y:H+12, vx:rnd(-0.7,0.7), vy:rnd(-12.5,-10.2), hue:rnd(0,360), bloom:rnd(140,220) });
}

// 3) 爆炸
function explode(x,y,hue,n){
  for(let i=0;i<n;i++){
    const a=Math.random()*Math.PI*2;
    const s=Math.pow(Math.random(),0.25)*rnd(2.2,6.6);
    const [r,g,b]=hsv(hue+rnd(-14,14), .82, 1);
    particles.push({ x,y, vx:Math.cos(a)*s, vy:Math.sin(a)*s, life:rnd(70,120), age:0, r,g,b });
  }
}

// 4) 动画主循环（进入页面立刻渲染，不依赖 setInterval 才能看到拖尾）
function loop(){
  // 轻度拖尾
  ctx.globalCompositeOperation='destination-out';
  ctx.fillStyle='rgba(0,0,0,0.22)';
  ctx.fillRect(0,0,W,H);
  ctx.globalCompositeOperation='lighter';

  // 火箭上升：到高空再爆（12%~22% 屏幕高度）
  for(let i=rockets.length-1;i>=0;i--){
    const r=rockets[i];
    r.x+=r.vx; r.y+=r.vy; r.vy+=G*0.40; // 上升阶段重力更轻
    ctx.fillStyle='rgba(255,255,255,.75)';
    ctx.fillRect(r.x, r.y, 2, 2);

    if(r.vy>-0.8 || r.y < H * rnd(0.12, 0.22)){
      explode(r.x, r.y, r.hue, r.bloom);
      rockets.splice(i,1);
    }
  }

  // 粒子更新
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.vx*=DRAG; p.vy=p.vy*DRAG+G;
    p.x+=p.vx; p.y+=p.vy; p.age++;
    const a=Math.max(0,1 - p.age/p.life);
    ctx.fillStyle=`rgba(${p.r|0},${p.g|0},${p.b|0},${a})`;
    ctx.beginPath(); ctx.arc(p.x,p.y,2,0,Math.PI*2); ctx.fill();
    if(p.age>p.life || p.y>H+16) particles.splice(i,1);
  }

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

// 5) 立刻放几发，保证“打开就有烟花”
for(let i=0;i<4;i++) setTimeout(()=>spawnRocket(rnd(W*0.3,W*0.7)), i*180);

// 之后持续随机发射
let rocketTimer = setInterval(()=>spawnRocket(), 900);

// 交互触发
addEventListener('pointerdown', e=>{ for(let i=0;i<2;i++) spawnRocket(e.clientX); });

// “放多点”按钮
const replayBtn = document.getElementById('replay');
if (replayBtn) {
  replayBtn.addEventListener('click', ()=>{
    for(let i=0;i<6;i++) setTimeout(()=>spawnRocket(), i*140);
  });
}
</script>
